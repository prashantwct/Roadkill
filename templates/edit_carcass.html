{% extends "base.html" %}
{% block content %}

<div class="row justify-content-center">
  <div class="col-lg-6">
    <div class="card shadow-sm p-4">

      <h3 class="mb-3">Edit Carcass {{ c.code }}</h3>

      <form method="POST">

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Animal Type</label>
            <select name="animal_type" id="animalType" class="form-select" onchange="updateSpeciesOptions()">
              <option value="Unknown" {% if c.animal_type == 'Unknown' %}selected{% endif %}>Unknown</option>
              <option value="Wild Animal" {% if c.animal_type == 'Wild Animal' %}selected{% endif %}>Wild Animal</option>
              <option value="Domestic Animal" {% if c.animal_type == 'Domestic Animal' %}selected{% endif %}>Domestic Animal</option>
            </select>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label">Species</label>
            <select name="species_select" id="speciesSelect" class="form-select" onchange="checkSpeciesOther()">
              </select>
            
            <div id="speciesCustomDiv" class="mt-2" style="display:none;">
              <input name="species_custom" id="speciesCustomInput" class="form-control" placeholder="Type species name...">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-6 mb-3">
             <label class="form-label">Latitude</label>
             <input name="latitude" class="form-control" value="{{ c.latitude }}">
          </div>
          <div class="col-6 mb-3">
             <label class="form-label">Longitude</label>
             <input name="longitude" class="form-control" value="{{ c.longitude }}">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="3">{{ c.notes }}</textarea>
        </div>

        <button class="btn btn-success w-100">Update Carcass</button>
        <a href="{{ url_for('view_carcass', carcass_id=c.id) }}" class="btn btn-link w-100 mt-2">Cancel</a>
      </form>

    </div>
  </div>
</div>

<script>
const speciesMap = {
  "Wild Animal": ["Jackal", "Jungle Cat", "Civet", "Other"],
  "Domestic Animal": ["Cattle", "Dog", "Buffalo", "Cat", "Other"],
  "Unknown": ["Unknown", "Other"]
};

function updateSpeciesOptions() {
  const typeSelect = document.getElementById('animalType');
  const speciesSelect = document.getElementById('speciesSelect');
  const type = typeSelect.value;
  const options = speciesMap[type] || ["Unknown", "Other"];

  // Save selection if trying to persist, otherwise just reset
  speciesSelect.innerHTML = "";
  options.forEach(opt => {
    const el = document.createElement("option");
    el.value = opt;
    el.textContent = opt;
    speciesSelect.appendChild(el);
  });
  
  checkSpeciesOther();
}

function checkSpeciesOther() {
  const speciesSelect = document.getElementById('speciesSelect');
  const customDiv = document.getElementById('speciesCustomDiv');
  const customInput = document.getElementById('speciesCustomInput');

  if (speciesSelect.value === 'Other') {
    customDiv.style.display = 'block';
    customInput.required = true;
  } else {
    customDiv.style.display = 'none';
    customInput.required = false;
  }
}

// Initialization Logic to handle saved data
document.addEventListener("DOMContentLoaded", function() {
  const savedSpecies = "{{ c.species }}";
  
  // 1. Populate dropdown based on the loaded Animal Type
  updateSpeciesOptions();
  
  const speciesSelect = document.getElementById('speciesSelect');
  const customInput = document.getElementById('speciesCustomInput');

  // 2. Try to select the saved species in the dropdown
  let found = false;
  for(let i=0; i<speciesSelect.options.length; i++){
    if(speciesSelect.options[i].value === savedSpecies){
      speciesSelect.selectedIndex = i;
      found = true;
      break;
    }
  }
  
  // 3. If not found in list (and not empty), it must be a custom "Other" value
  if(!found && savedSpecies && savedSpecies !== 'None') {
    speciesSelect.value = 'Other';
    checkSpeciesOther(); // Show the input
    customInput.value = savedSpecies;
  }
});
</script>

{% endblock %}
