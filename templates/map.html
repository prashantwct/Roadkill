{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* Full height map area */
    #map-container {
        position: relative;
        height: calc(100vh - 70px); /* Adjust based on your navbar height */
        width: 100%;
        overflow: hidden;
    }
    #map { height: 100%; width: 100%; }

    /* Floating Filter Panel */
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        width: 250px;
        max-height: 80vh;
        overflow-y: auto;
    }

    /* Floating "Find Me" Button */
    .locate-btn {
        position: absolute;
        bottom: 25px;
        right: 10px;
        z-index: 1000;
        background: white;
        border: 2px solid rgba(0,0,0,0.2);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .locate-btn:active { transform: scale(0.95); }

    /* Live User Marker (Blue Pulse) */
    .user-pulse {
        background: rgba(66, 133, 244, 0.4);
        border-radius: 50%;
        height: 100%;
        width: 100%;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(0.5); opacity: 1; }
        100% { transform: scale(1.5); opacity: 0; }
    }
    
    /* Popup Styling */
    .popup-header {
        font-size: 1.1rem;
        font-weight: bold;
        border-bottom: 2px solid #dc3545;
        margin-bottom: 5px;
        padding-bottom: 5px;
    }
</style>

<div id="map-container">
    <div id="map"></div>

    <div class="map-controls">
        <h6 class="fw-bold mb-3"><i class="fa fa-filter"></i> Filters</h6>
        
        <div class="mb-2">
            <label class="small text-muted">Species</label>
            <select id="filterSpecies" class="form-select form-select-sm" onchange="applyFilters()">
                <option value="all">All Species</option>
                {% for s in all_species %}
                    <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-2">
            <label class="small text-muted">Type</label>
            <select id="filterType" class="form-select form-select-sm" onchange="applyFilters()">
                <option value="all">All Types</option>
                {% for t in all_types %}
                    <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="small text-muted">Site</label>
            <select id="filterSite" class="form-select form-select-sm" onchange="applyFilters()">
                <option value="all">All Sites</option>
                {% for site in all_sites %}
                    <option value="{{ site }}">{{ site }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="d-grid">
            <button class="btn btn-sm btn-outline-danger" onclick="resetFilters()">Reset</button>
        </div>
        
        <hr>
        <div class="small text-muted">
            <strong>Total Visible:</strong> <span id="count-display">0</span>
        </div>
    </div>

    <button class="locate-btn" onclick="snapToUser()" title="Find My Location">
        üìç
    </button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    // 1. DATA INJECTION (Pass Flask data to JS)
    const carcassData = [
        {% for c in carcasses %}
        {
            id: {{ c.id }},
            code: "{{ c.code }}",
            species: "{{ c.species }}",
            type: "{{ c.animal_type }}",
            site: "{{ c.site.code }}",
            lat: {{ c.latitude }},
            lng: {{ c.longitude }},
            date: "{{ c.datetime_found.strftime('%Y-%m-%d') }}",
            samples: {{ c.samples|length }}
        },
        {% endfor %}
    ];

    // 2. INITIALIZE MAP
    // Default center India
    var map = L.map('map').setView([22.35, 78.66], 5);

    // 3. DEFINE LAYERS
    var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '¬© OpenStreetMap'
    });

    var satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19, attribution: '¬© Esri'
    });

    // Add default layer
    streetLayer.addTo(map);

    // Layer Control
    var baseMaps = {
        "Street View": streetLayer,
        "Satellite": satLayer
    };
    L.control.layers(baseMaps).addTo(map);

    // 4. MARKER CLUSTERING & FILTERING
    var markers = L.markerClusterGroup(); // Initialize cluster group

    function applyFilters() {
        markers.clearLayers(); // Remove current pins

        var selSpecies = document.getElementById('filterSpecies').value;
        var selType = document.getElementById('filterType').value;
        var selSite = document.getElementById('filterSite').value;
        var count = 0;

        carcassData.forEach(function(c) {
            // Check logic
            var matchSpecies = (selSpecies === 'all' || c.species === selSpecies);
            var matchType = (selType === 'all' || c.type === selType);
            var matchSite = (selSite === 'all' || c.site === selSite);

            if (matchSpecies && matchType && matchSite) {
                // Determine Icon Color based on Type (Simple logic)
                var markerColor = 'blue';
                if (c.type === 'Carnivore') markerColor = 'red';
                else if (c.type === 'Herbivore') markerColor = 'green';
                
                // Create Marker
                var marker = L.marker([c.lat, c.lng]);

                // Bind Rich Popup
                var popupContent = `
                    <div style="min-width: 200px;">
                        <div class="popup-header">${c.species}</div>
                        <strong>Code:</strong> ${c.code}<br>
                        <strong>Date:</strong> ${c.date}<br>
                        <strong>Type:</strong> ${c.type}<br>
                        <span class="badge ${c.samples > 0 ? 'bg-success' : 'bg-secondary'} mb-2">
                            ${c.samples} Samples
                        </span>
                        <a href="/carcass/${c.id}" class="btn btn-primary btn-sm w-100 mt-2">View Record</a>
                    </div>
                `;
                marker.bindPopup(popupContent);
                markers.addLayer(marker); // Add to cluster
                count++;
            }
        });

        map.addLayer(markers); // Add cluster group to map
        document.getElementById('count-display').innerText = count;
    }

    // Run filter once on load
    applyFilters();

    function resetFilters() {
        document.getElementById('filterSpecies').value = 'all';
        document.getElementById('filterType').value = 'all';
        document.getElementById('filterSite').value = 'all';
        applyFilters();
    }

    // ==========================================
    //  5. LIVE LOCATION (ALWAYS ACTIVE)
    // ==========================================
    var userMarker = null;
    var userCircle = null;
    var currentLat = null;
    var currentLng = null;

    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
            successLocation, 
            errorLocation, 
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    }

    function successLocation(position) {
        currentLat = position.coords.latitude;
        currentLng = position.coords.longitude;
        var acc = position.coords.accuracy;

        if (!userMarker) {
            // CREATE BLUE DOT
            userMarker = L.circleMarker([currentLat, currentLng], {
                radius: 8,
                fillColor: "#4285F4",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map);

            // CREATE ACCURACY CIRCLE
            userCircle = L.circle([currentLat, currentLng], {
                radius: acc,
                color: '#4285F4',
                fillColor: '#4285F4',
                fillOpacity: 0.1,
                weight: 0
            }).addTo(map);

            // Bind "Record Here" Popup to the User Dot
            var userPopup = `
                <div class="text-center">
                    <strong>You are here</strong><br>
                    <span class="text-muted" style="font-size: 0.8em">Accuracy: ${Math.round(acc)}m</span><br>
                    <a href="/carcass/new?site_id=1&latitude=${currentLat}&longitude=${currentLng}" 
                       class="btn btn-success btn-sm mt-2">
                       + Record Carcass Here
                    </a>
                </div>
            `;
            userMarker.bindPopup(userPopup);

            // Zoom to user on first load
            map.setView([currentLat, currentLng], 15);

        } else {
            // UPDATE POSITION
            userMarker.setLatLng([currentLat, currentLng]);
            userCircle.setLatLng([currentLat, currentLng]);
            userCircle.setRadius(acc);
            
            // Update the "Record Here" link in the popup with new coords
            var newPopup = `
                <div class="text-center">
                    <strong>You are here</strong><br>
                    <span class="text-muted" style="font-size: 0.8em">Accuracy: ${Math.round(acc)}m</span><br>
                    <a href="/carcass/new?site_id=1&latitude=${currentLat}&longitude=${currentLng}" 
                       class="btn btn-success btn-sm mt-2">
                       + Record Carcass Here
                    </a>
                </div>
            `;
            userMarker.setPopupContent(newPopup);
        }
    }

    function errorLocation(err) {
        console.log("GPS Error: " + err.message);
    }

    function snapToUser() {
        if (currentLat && currentLng) {
            map.setView([currentLat, currentLng], 18);
            if (userMarker) userMarker.openPopup();
        } else {
            alert("Getting your location... ensure GPS is on.");
        }
    }

</script>
{% endblock %}
