{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* Full Map Layout */
    #map-wrapper {
        position: relative;
        height: calc(100vh - 56px); /* Adjusts for navbar height */
        width: 100%;
        overflow: hidden;
    }
    #map { height: 100%; width: 100%; z-index: 1; }

    /* FLOATING PANEL STYLES */
    .map-overlay-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        width: 300px; /* Slightly wider for dates */
        max-height: 85vh;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: transform 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
    }

    .panel-header {
        padding: 10px 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

    .panel-body {
        padding: 15px;
        overflow-y: auto;
    }

    /* COLLAPSED STATE */
    .panel-collapsed .panel-body { display: none; }
    .panel-collapsed { width: auto; }
    .panel-collapsed .panel-title { display: none; }
    
    /* CUSTOM MARKER STYLES */
    .custom-marker { 
        border: 2px solid white; 
        box-shadow: 1px 1px 4px rgba(0,0,0,0.5); 
    }
    .marker-wild { background-color: #dc3545; border-radius: 50%; }     /* Red Circle */
    .marker-domestic { background-color: #000000; border-radius: 0%; }  /* Black Square */
    .marker-other { background-color: #6c757d; border-radius: 50%; }    /* Grey Circle */

    /* LIVE LOCATION PULSE */
    .user-pulse {
        background: rgba(66, 133, 244, 0.4);
        border-radius: 50%;
        height: 100%;
        width: 100%;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(0.5); opacity: 1; }
        100% { transform: scale(1.5); opacity: 0; }
    }
</style>

<div id="map-wrapper">
    <div id="map"></div>

    <div id="filterPanel" class="map-overlay-panel">
        <div class="panel-header" onclick="togglePanel()">
            <span class="panel-title fw-bold"><i class="fa-solid fa-layer-group me-2"></i>Map Controls</span>
            <i class="fa-solid fa-bars"></i>
        </div>
        
        <div class="panel-body">
            
            <label class="small fw-bold text-muted mb-2">MODE</label>
            <div class="btn-group w-100 mb-3" role="group">
                <input type="radio" class="btn-check" name="visMode" id="modeCluster" autocomplete="off" checked onchange="applyFilters()">
                <label class="btn btn-sm btn-outline-primary" for="modeCluster">Markers</label>

                <input type="radio" class="btn-check" name="visMode" id="modeHeat" autocomplete="off" onchange="applyFilters()">
                <label class="btn btn-sm btn-outline-danger" for="modeHeat">Heatmap</label>
            </div>

            <hr class="my-2">

            <label class="small fw-bold text-muted mb-2">SEARCH & FILTER</label>

            <div class="mb-2">
                <input type="text" id="searchCode" class="form-control form-control-sm" placeholder="Search Code (e.g. A102)..." oninput="applyFilters()">
            </div>

            <div class="mb-2 row g-1">
                <div class="col-6">
                    <label class="small text-muted" style="font-size: 0.75rem;">From</label>
                    <input type="date" id="dateFrom" class="form-control form-control-sm" onchange="applyFilters()">
                </div>
                <div class="col-6">
                    <label class="small text-muted" style="font-size: 0.75rem;">To</label>
                    <input type="date" id="dateTo" class="form-control form-control-sm" onchange="applyFilters()">
                </div>
            </div>

            <div class="mb-2">
                <label class="small">Site</label>
                <select id="filterSite" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">All Sites</option>
                    {% for site in all_sites %}
                    <option value="{{ site }}">{{ site }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-2">
                <label class="small">Animal Type</label>
                <select id="filterType" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">All Types</option>
                    {% for t in all_types %}
                    <option value="{{ t }}">{{ t }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label class="small">Species</label>
                <select id="filterSpecies" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="all">All Species</option>
                    {% for s in all_species %}
                    <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">Reset</button>
                <span class="badge bg-secondary" id="countBadge">Loading...</span>
            </div>
            
            <div id="legendBox" class="mt-3 small border-top pt-2">
                <div class="d-flex align-items-center mb-1"><span class="marker-wild me-2" style="width:10px; height:10px; display:inline-block;"></span> Wild</div>
                <div class="d-flex align-items-center mb-1"><span class="marker-domestic me-2" style="width:10px; height:10px; display:inline-block;"></span> Domestic</div>
                <div class="d-flex align-items-center"><span class="marker-other me-2" style="width:10px; height:10px; display:inline-block;"></span> Other</div>
            </div>
        </div>
    </div>

    <button class="btn btn-light shadow rounded-circle" 
            style="position: absolute; bottom: 20px; right: 20px; width: 50px; height: 50px; z-index: 1000;"
            onclick="snapToUser()">
        <i class="fa-solid fa-crosshairs fa-lg"></i>
    </button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    // ==========================================
    // 1. PREPARE DATA FROM FLASK
    // ==========================================
    const rawData = [
        {% for c in carcasses %}
        {
            id: {{ c.id }},
            code: "{{ c.code }}",
            site: "{{ c.site.code }}",
            species: "{{ c.species }}",
            type: "{{ c.animal_type }}",
            lat: {{ c.latitude }},
            lng: {{ c.longitude }},
            date: "{{ c.datetime_found.strftime('%Y-%m-%d') }}",
            link: "{{ url_for('view_carcass', carcass_id=c.id) }}"
        },
        {% endfor %}
    ];

    // ==========================================
    // 2. INITIALIZE MAP
    // ==========================================
    var map = L.map('map').setView([22.35, 78.66], 5);

    // Base Layers
    var streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: 'OSM'});
    var satMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom: 19, attribution: 'Esri'});
    
    streetMap.addTo(map);
    L.control.layers({"Street": streetMap, "Satellite": satMap}).addTo(map);

    // ==========================================
    // 3. LAYER GROUPS
    // ==========================================
    var markersLayer = L.markerClusterGroup({
        showCoverageOnHover: false,
        maxClusterRadius: 50
    });
    var heatLayer = null;

    // ==========================================
    // 4. HELPER: ICON GENERATOR
    // ==========================================
    function getCustomIcon(type) {
        let className = 'marker-other';
        let t = (type || '').toLowerCase();
        
        if (t.includes('wild') || t.includes('carnivore') || t.includes('herbivore')) {
            className = 'marker-wild';
        } else if (t.includes('domestic')) {
            className = 'marker-domestic';
        }

        return L.divIcon({
            className: 'custom-marker ' + className,
            iconSize: [12, 12],
            iconAnchor: [6, 6],
            popupAnchor: [0, -6]
        });
    }

    // ==========================================
    // 5. FILTER & RENDER LOGIC
    // ==========================================
    function applyFilters() {
        // Get Dropdown Values
        const fSite = document.getElementById('filterSite').value;
        const fType = document.getElementById('filterType').value;
        const fSpecies = document.getElementById('filterSpecies').value;
        const isHeatmap = document.getElementById('modeHeat').checked;

        // Get Search & Date Values
        const searchVal = document.getElementById('searchCode').value.trim().toLowerCase();
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        // 1. Filter Data
        const visibleData = rawData.filter(d => {
            // Dropdowns
            if (fSite !== 'all' && d.site !== fSite) return false;
            if (fType !== 'all' && d.type !== fType) return false;
            if (fSpecies !== 'all' && d.species !== fSpecies) return false;
            
            // Search Code (Partial Match)
            if (searchVal && !d.code.toLowerCase().includes(searchVal)) return false;

            // Date Range
            if (dateFrom && d.date < dateFrom) return false;
            if (dateTo && d.date > dateTo) return false;

            return true;
        });

        // 2. Clear current layers
        markersLayer.clearLayers();
        if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
        map.removeLayer(markersLayer);

        // 3. Render based on Mode
        if (isHeatmap) {
            // HEATMAP MODE
            document.getElementById('legendBox').style.display = 'none';
            const heatPoints = visibleData.map(d => [d.lat, d.lng, 1.0]); 
            heatLayer = L.heatLayer(heatPoints, {radius: 25, blur: 15, maxZoom: 12}).addTo(map);
        } else {
            // MARKER MODE
            document.getElementById('legendBox').style.display = 'block';
            visibleData.forEach(d => {
                let marker = L.marker([d.lat, d.lng], { icon: getCustomIcon(d.type) });
                
                let popup = `
                    <div class="text-center p-1">
                        <strong>${d.species}</strong><br>
                        <span class="badge bg-light text-dark border">${d.code}</span><br>
                        <span class="text-muted small">${d.date}</span><br>
                        <a href="${d.link}" class="btn btn-sm btn-primary mt-2 w-100">View</a>
                    </div>
                `;
                marker.bindPopup(popup);
                markersLayer.addLayer(marker);
            });
            map.addLayer(markersLayer);
        }

        document.getElementById('countBadge').innerText = visibleData.length + " Found";
    }

    // ==========================================
    // 6. UI FUNCTIONS
    // ==========================================
    function togglePanel() {
        document.getElementById('filterPanel').classList.toggle('panel-collapsed');
    }
    
    function resetFilters() {
        // Reset Dropdowns
        document.getElementById('filterSite').value = 'all';
        document.getElementById('filterType').value = 'all';
        document.getElementById('filterSpecies').value = 'all';
        // Reset Inputs
        document.getElementById('searchCode').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        
        applyFilters();
    }

    // ==========================================
    // 7. LIVE LOCATION
    // ==========================================
    var userMarker = null;
    var userCircle = null;
    var currentLat = null;
    var currentLng = null;

    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
            (pos) => {
                currentLat = pos.coords.latitude;
                currentLng = pos.coords.longitude;
                const acc = pos.coords.accuracy;

                if (!userMarker) {
                    userMarker = L.circleMarker([currentLat, currentLng], {
                        radius: 8, fillColor: "#4285F4", color: "#fff", weight: 2, fillOpacity: 1
                    }).addTo(map);
                    
                    userCircle = L.circle([currentLat, currentLng], {
                        radius: acc, color: '#4285F4', fillOpacity: 0.1, weight: 0
                    }).addTo(map);

                    bindUserPopup(acc);
                    map.setView([currentLat, currentLng], 15);
                } else {
                    userMarker.setLatLng([currentLat, currentLng]);
                    userCircle.setLatLng([currentLat, currentLng]).setRadius(acc);
                    bindUserPopup(acc);
                }
            },
            (err) => console.warn("GPS Error", err),
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    function bindUserPopup(acc) {
        if(!userMarker) return;
        userMarker.bindPopup(`
            <div class="text-center">
                <strong>Your Location</strong><br>
                <small class="text-muted">Â±${Math.round(acc)}m accuracy</small><br>
                <a href="/carcass/new?latitude=${currentLat}&longitude=${currentLng}" 
                   class="btn btn-success btn-sm mt-2">+ Record Here</a>
            </div>
        `);
    }

    function snapToUser() {
        if (currentLat && currentLng) {
            map.setView([currentLat, currentLng], 18);
            userMarker.openPopup();
        } else {
            alert("Locating you...");
        }
    }

    // Run on Load
    applyFilters();

</script>
{% endblock %}
